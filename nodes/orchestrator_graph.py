# nodes/orchestrator_graph.py
from langgraph.graph import StateGraph, START, END
from datetime import datetime, timedelta
from typing import TypedDict, Annotated
from nodes.field_map import FIELD_MAP
import operator
import asyncio
from concurrent.futures import ThreadPoolExecutor

class State(TypedDict):
    raw_input: str
    decisions: dict
    sections: list[str]
    completed_sections: Annotated[list, operator.add]

def generate_auto_dates():
    today = datetime.today()
    return {
        "Issue_Date": today.strftime("%Y-%m-%d"),
        "Participation_Confirmation_Letter": (today + timedelta(days=2)).strftime("%Y-%m-%d"),
        "Submission_of_Questions_and_Inquiries": (today + timedelta(days=5)).strftime("%Y-%m-%d"),
        "Submission_of_Proposals": (today + timedelta(days=10)).strftime("%Y-%m-%d"),
        "Opening_of_Proposals": (today + timedelta(days=11)).strftime("%Y-%m-%d"),
        "Award_Decision_Date": (today + timedelta(days=17)).strftime("%Y-%m-%d"),
        "Commencement_of_Work": (today + timedelta(days=30)).strftime("%Y-%m-%d"),
    }

def apply_defaults(d):
    d["Joint_Venture"] = d.get("Joint_Venture") or (
        """ 

        :ูุฌูุฒ ูููุชูุงูุณูู ุงูุชุถุงูู ูููุง ุจูููู ูุชูุฏูู ุงูุนุฑูุถ ุนูู ุฃู ุชุชูุงูุฑ ุงูุดุฑูุท ุงูุขุชูุฉ

        """
        "\n:ูุฌูุฒ ูููุชูุงูุณูู ุงูุชุถุงูู ูููุง ุจูููู ูุชูุฏูู ุงูุนุฑูุถ ุนูู ุฃู ุชุชูุงูุฑ ุงูุดุฑูุท ุงูุขุชูุฉ"  + 
        "โุฃ. ุฃู ูุชู ุงูุชุถุงูู ูุจู ุชูุฏูู ุงูุนุฑุถ ุจููุฌุจ ุงุชูุงููุฉ ุชุถุงูู ูุจุฑูุฉ ุจูู ุงููุชูุงูุณูู ููุตุฏูุฉ ูู ุงูุบุฑูุฉ ุงูุชุฌุงุฑูุฉ ููู ุงูุฌูุงุช ุงููุฎููุฉ ุจุงูุชูุซูู\n"
        "โุจ. ุฃู ูุญุฏุฏ ูู ุงูุงุชูุงููุฉ ูุงุฆุฏ ุงูุชุถุงูู ูููุซู ูุงูููู ุฃูุงู ุงูุฌูุฉ ุงูุญููููุฉ ูุงุณุชููุงู ุฅุฌุฑุงุกุงุช ุงูุชุนุงูุฏ ูุชูููุน ุงูุนูุฏ ูุงููุฑุงุณูุงุช ูุงููุฎุงุทุจุงุช\n"
        "โุฌ. ุฃู ููุถุญ ูู ุงูุงุชูุงููุฉ ุงูุฃุนูุงู ุงูุชู ุณูููู ุจูุง ูู ุทุฑู ูู ุฃุทุฑุงู ุงูุชุถุงูู.\n"
        "โุฏ. ุฃู ุชูุต ุงุชูุงููุฉ ุงูุชุถุงูู ุนูู ุงูุชุฒุงู ููุณุคูููุฉ ุงููุชุถุงูููู ูุฌุชูุนูู ุฃู ูููุฑุฏูู ุนู ุชูููุฐ ูุงูุฉ ุงูุฃุนูุงู ุงููุทุฑูุญุฉ ูู ุงูููุงูุณุฉ.\n"
        "โู. ุฃู ูุฎุชู ุงูุนุฑุถ ูุฌููุน ูุซุงุฆูู ููุณุชูุฏุงุชู ูู ุฌููุน ุฃุทุฑุงู ุงูุชุถุงูู.\n"
        "โู. ุชูุฏู ุงุชูุงููุฉ ุงูุชุถุงูู ูุน ุงูุนุฑุถ ูุฌููุน ูุซุงุฆูู ููุณุชูุฏุงุชู.\n"
        "โุฒ. ูุง ูุฌูุฒ ูุฃู ุทุฑู ูู ุฃุทุฑุงู ุงูุชุถุงูู ุงูุชูุฏู ููููุงูุณุฉ ุจุนุฑุถ ูููุฑุฏ ุฃู ุงูุชุถุงูู ูุน ููุงูุณ ุขุฎุฑ.\n"
        "โุญ. ูุง ูุฌูุฒ ุชุนุฏูู ุงุชูุงููุฉ ุงูุชุถุงูู ุจุนุฏ ุชูุฏูููุง ุฅูุง ุจููุงููุฉ ุงูุฌูุฉ ุงูุญููููุฉ." 
    )
async def _call_llm_async(llm, prompt):
    if hasattr(llm, "ainvoke"):
        try:
            result = await llm.ainvoke(prompt)
            return getattr(result, "content", result).strip()
        except Exception:
            pass

    loop = asyncio.get_running_loop()
    def sync():
        try:
            result = llm.invoke(prompt)
            return getattr(result, "content", result).strip()
        except Exception:
            return "ุชุนุฐุฑ ุชูููุฏ ุงูููุฑุฉ ุจุณุจุจ ุฎุทุฃ ุชููู."

    return await loop.run_in_executor(ThreadPoolExecutor(max_workers=6), sync)
   

def orchestrator(state: State):
    state.setdefault("decisions", {})
    d = state["decisions"]
    d.update(generate_auto_dates())
    apply_defaults(d)
    sections = [k for k, v in FIELD_MAP.items() if v == "llm"]
    return {"sections": sections, "decisions": d}

def generate_all_sections(state, llm):
    state.setdefault("decisions", {})
    d = state["decisions"]
    sections = state.get("sections", [])
    completed = {}

    context = f"""
    ุงูุฌูุฉ ุงูุญููููุฉ: {d.get('Government_Agency', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ุงุณู ุงูููุงูุณุฉ: {d.get('Competition_Name', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ุชุงุฑูุฎ ุงูุฅุนูุงู: {d.get('Announcement_Date', 'ุบูุฑ ูุญุฏุฏ')}
    ูููุน ุงูุชูููุฐ: {d.get('Service_Execution_Location', 'ุบูุฑ ูุญุฏุฏ')}
    ุฎุทุฉ ุงูุชูููุฐ: {d.get('Service_Delivery_Plan', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ูุชุทูุจุงุช ุงููุญุชูู ุงููุญูู: {d.get('Local_Content_Requirements', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ุงูุดุฑูุท ุงูุฎุงุตุฉ: {d.get('Special_Conditions', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ุทุฑููุฉ ุงูุฏูุน: {d.get('Payment_Method', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุงุณุชูุณุงุฑุงุช: {d.get('Inquiry_Response_Email', 'ุบูุฑ ูุญุฏุฏ')}
    ุงูุถูุงู ุงูุงุจุชุฏุงุฆู: {d.get('Initial_Guarantee_Percentage', 'ุบูุฑ ูุญุฏุฏ')}
    ููุน ุงููุดุฑูุน: {d.get('Project_Type', 'ุบูุฑ ูุญุฏุฏ')}
    ูุฏุฉ ุงููุดุฑูุน: {d.get('Project_Duration', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ุทุฑููุฉ ุงูุชุฑุณูุฉ: {d.get('Award_Method', 'ุบูุฑ ูุญุฏุฏุฉ')}
    ูุดูู ูุนุฏุงุช: {d.get('Includes_Equipment', 'ุบูุฑ ูุญุฏุฏ')}
    ุงููุญุชูู ุงููุญูู: {d.get('Local_Content_Requirements', 'ุบูุฑ ูุญุฏุฏุฉ')}
    """

    prompts = {
        "Competition_Definition": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุชุนุฑูู ุงูููุงูุณุฉ" ุจูุงุกู ุนูู ุงููุนูููุงุช ุงูุชุงููุฉ:

        ุงุณู ุงูุฌูุฉ: {d.get('Government_Agency')}
        ุงุณู ุงูููุงูุณุฉ: {d.get('Competition_Name')}
        ุงููููุน: {d.get('Service_Execution_Location')}
        ุงููุฏู ุงูุฑุฆูุณู: {d.get('Project_Main_Objective')}

        ุงูุชุจ ูุตุงู ุฑุณููุงู ููุฌุฒุงู ููุถุญ:
        - ูุฏู ุงูููุงูุณุฉ
        - ุฃู ูุทุงู ุงูุนูู ูุงููุชุทูุจุงุช ูุฐููุฑุฉ ูู ูุฑุงุณุฉ ุงูุดุฑูุท
        - ุฃู ุชูุฏูู ุงูุนุฑูุถ ูุฌุจ ุฃู ูุชู ุถูู ุงูููุนุฏ ุงูููุงุฆู ูููุชูู ุงููุณุชูุฏุงุช
        - ุฃู ุงูุชูููุฐ ูุชู ููู ุงูุฌุฏูู ุงูุฒููู ุฏุงุฎู ุงููุณุชูุฏุงุช

        ูุง ุชูุฑุฑ ุงูุฃุฑูุงู ุฃู ุงูุชูุงุตูู ุงููููุฉุ ููุท ุชุนุฑูู ุฑุณูู ูุงุถุญ.
        """,

        "Regulatory_Records_and_Licenses": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ููุงุถุญุฉ ุจุนููุงู "ุงูุณุฌูุงุช ูุงูุชุฑุงุฎูุต ุงููุธุงููุฉ" ูุชุฏุฑุฌ ุถูู ูุฑุงุณุฉ ุงูุดุฑูุท ูุงูููุงุตูุงุช.

        ุงูุชุนูููุงุช:
        - ูุฌุจ ุฃู ุชุจุฏุฃ ุงูููุฑุฉ ุจุชุฃููุฏ ุงูุชุฒุงู ุงููุชูุงูุณูู ุจุชูุฏูู ุฌููุน ุงููุณุชูุฏุงุช ุงููุธุงููุฉ ุงูุณุงุฑูุฉุ ูุฃู ุชููู ุตุญูุญุฉ ููุงุจูุฉ ููุชุญูู.
        - ูุฌุจ ุชูุณูู ุงููุณุชูุฏุงุช ุฅูู ูุฆุชูู: ูุณุชูุฏุงุช ุฃุณุงุณูุฉ ูุทููุจุฉ ูู ุฌููุน ุงููุชูุงูุณููุ ููุณุชูุฏุงุช ุฅุถุงููุฉ ูุฑุชุจุทุฉ ุจุทุจูุนุฉ ุงููุดุฑูุน.

        ุงููุณุชูุฏุงุช ุงูุฃุณุงุณูุฉ ุงููุทููุจุฉ ูู ุฌููุน ุงููุชูุงูุณูู:
        โข ุงูุณุฌู ุงูุชุฌุงุฑู ุงููุญุฏุซุ ุนูู ุฃู ูุบุทู ุงููุดุงุท ุงููุฑุชุจุท ุจูุทุงู ุงูููุงูุณุฉ.  
        โข ุดูุงุฏุฉ ุงูุฒูุงุฉ ูุงูุถุฑูุจุฉ (ุฃู ุดูุงุฏุฉ ุงูุถุฑูุจุฉ ููุท ุฅู ููุฌุฏุช) ุณุงุฑูุฉ ุงูููุนูู.  
        โข ุดูุงุฏุฉ ุงูุบุฑูุฉ ุงูุชุฌุงุฑูุฉ (ุนุถููุฉ ุณุงุฑูุฉ).

        ุฅุฐุง ูุงู ููุน ุงููุดุฑูุน ูุชุทูุจ ููุงุฏุฑ ุจุดุฑูุฉ ุฃู ุชุดุบูููุง ููุฏุงูููุง (ูุซู ูุดุงุฑูุน: ุงูุชุดุบููุ ุงูุตูุงูุฉุ ุงูุฅุดุฑุงูุ ุชุดุบูู ูุฑุงููุ ุชูุฏูู ููุงุฑุฏ ุจุดุฑูุฉ)ุ ุชุทูุจ ุฃูุถูุง:
        โข ุดูุงุฏุฉ ุงููุคุณุณุฉ ุงูุนุงูุฉ ููุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ ุชุซุจุช ุชุณุฌูู ุงูุนุงูููู ูุฏู ุงูุฌูุฉ ุงููุฎุชุตุฉ.

        ูุฅุฐุง ูุงูุช ุทุจูุนุฉ ุงููุดุฑูุน ูุฑุชุจุทุฉ ุจูุนุฏุงุช ุฃู ุชุดุบูู ูู ููุงูุน ุญุณุงุณุฉ ุฃู ููุง ูุชุทูุจุงุช ุฎุงุตุฉ (ูุซู ุงููุดุงุฑูุน ุงูุชูููุฉ ุฃู ุงูููุฏุณูุฉ ุฃู ุงููุดุงุฑูุน ุฐุงุช ุงูุฃุซุฑ ุงูุจูุฆู)ุ ุชุทูุจ ุฃูุถูุง:
        โข ุชุฑุงุฎูุต ุฃู ุชุตุงุฑูุญ ุฅุถุงููุฉ ูุซู: ุชุตุงุฑูุญ ุจูุฆูุฉุ ุชุตุงุฑูุญ ุจูุฏูุฉุ ุฃู ุชุตุงุฑูุญ ูุฒุงููุฉ ุงููุดุงุท.

        ููุฑุฉ ุฎุชุงููุฉ:
        ุชุญุชูุธ ุงูุฌูุฉ ุจุญู ุทูุจ ุงููุณุฎ ุงูุฃุตููุฉ ุฃู ุงููุณุฎ ุงููุตุฏูุฉ ูุงูุชุญูู ูู ุตุญุฉ ุงููุณุชูุฏุงุช ุนุจุฑ ุงูุฌูุงุช ุงููุฎุชุตุฉุ ููุนุฏ ุนุฏู ุชูุฏูู ูุณุชูุฏ ุฃู ุงูุชูุงุก ุตูุงุญูุชู ุฃู ุซุจูุช ุนุฏู ุตุญุชู ุณุจุจูุง ูู ุงุณุชุจุนุงุฏ ุงูุนุฑุถ ููู ุงูุฃูุธูุฉ ูุงูุชุนูููุงุช ุงููุนููู ุจูุง ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ.

        ุงููุนุทูุงุช ููุงุณุชุฏูุงู (ูุง ุชูุฐูุฑ ุฏุงุฎู ุงููุต):
        ููุน ุงููุดุฑูุน: {d.get('Project_Type', 'ุบูุฑ ูุญุฏุฏ')}
        ูุดูู ููุงุฏุฑ ุจุดุฑูุฉุ {d.get('Includes_Equipment', 'ุบูุฑ ูุญุฏุฏ')}
        ุงููุญุชูู ุงููุญูู: {d.get('Local_Content_Requirements', 'ุบูุฑ ูุญุฏุฏุฉ')}
        """,

        "Project_Scope_of_Work":  f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ูุทุงู ุงูุนูู" ูุชุฏุฑุฌ ูู ูุฑุงุณุฉ ุงูุดุฑูุท ูุงูููุงุตูุงุช ุงูุฎุงุตุฉ ุจุงูููุงูุณุฉ.
        ุงุณุชุฎุฏู ุงููุนูููุงุช ุงูุขุชูุฉ ููุตุฏุฑ ุณูุงูู ุนุงู ููุท ุฏูู ุฅุนุงุฏุฉ ุชูุงุตูููุง ุงูุฅุฏุงุฑูุฉ:

        {context}

         ุงูุชุนูููุงุช:
        - ุตูุบ ุงูููุฑุฉ ุจุฃุณููุจ ุงุญุชุฑุงูู ูุชูุงุณุจ ูุน ุทุจูุนุฉ ุงููุดุฑูุน (ุฎุฏูุงุช ุชุดุบููุ ุงุณุชุดุงุฑุงุชุ ุตูุงูุฉุ ุชุทููุฑ ุชูููุ ุฃู ุฃุนูุงู ููุฏุณูุฉ).  
        - ูุถูุญ ุจุนุจุงุฑุงุช ุฑุณููุฉ ุดุงููุฉ ุงูููุงู ูุงููุณุคูููุงุช ุงูุชู ูุชุนูู ุนูู ุงููุชุนุงูุฏ ุชูููุฐูุงุ ุจูุง ูู ุฐูู ุงูุฃูุดุทุฉ ุงูุฃุณุงุณูุฉ ูุงููุฎุฑุฌุงุช ุงููุชููุนุฉ.  
        - ููููู ุชูุณูู ุงููุทุงู ุฅูู ููุงุท ุฑุฆูุณูุฉ ุฃู ูุฑุงุญู ุนุงูุฉ ุนูุฏ ุงูุญุงุฌุฉ.  
        - ุฃุดุฑ ุฅูู ุญุฏูุฏ ุงููุทุงู (ูุง ูุดููู ุงูุชูููุฐุ ููุง ูุง ูุดููู).  
        - ุฑููุฒ ุนูู ุชุญููู ุงูุฃูุฏุงู ุงูุชุดุบูููุฉ ุฃู ุงูุชุทููุฑูุฉ ูููุดุฑูุนุ ุฏูู ุฐูุฑ ุงูุฃุณุนุงุฑ ุฃู ุงูุชูุงุฑูุฎ ุฃู ุงูุฌูุฉ ุงูุญููููุฉ ุจุงูุงุณู.  
        - ุงุณุชุฎุฏู ูุบุฉ ุฑุณููุฉ ูุชุณูุฉ ูุน ุฃุณููุจ ูุฒุงุฑุฉ ุงููุงููุฉ ูููุฆุฉ ููุงุกุฉ ุงูุฅููุงู ูุงููุดุฑูุนุงุช ุงูุญููููุฉ (EXPRO).

        ุงูุชุจ ุงููุต ุจุงูุนุฑุจูุฉ ุงููุตุญูุ ููุณููุง ูุฌุงูุฒูุง ููุฅุฏุฑุงุฌ ูู ูุซููุฉ ุฑุณููุฉ.
        """,
        
        "Technical_Proposal_Documents": f"""
        ุฃูุช ุฎุจูุฑ ูู ูุชุงุจุฉ ูุฑุงุณุงุช ุงูุดุฑูุท ุงูุญููููุฉ (RFP) ููู ูููุฌูุฉ ูุฒุงุฑุฉ ุงููุงููุฉ ูููุฆุฉ ููุงุกุฉ ุงูุฅููุงู ูุงููุดุฑูุนุงุช ุงูุญููููุฉ (EXPRO).

        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู **"ูุซุงุฆู ุงูุนุฑุถ ุงูููู"** ูุชุฏุฑุฌ ุถูู ูุฑุงุณุฉ ุงูุดุฑูุท ุงูุฎุงุตุฉ ุจุงูููุงูุณุฉ.

        โ ุงุณุชุฎุฏู ุงููุนูููุงุช ุงูุชุงููุฉ ููุท ููุฑุฌุน ูู ุงูููู ุฏูู ุฅุนุงุฏุฉ ุฐูุฑูุง ูุตูุง ุฏุงุฎู ุงูููุฑุฉ:
        - ููุน ุงููุดุฑูุน: {d.get('Project_Type', 'ุบูุฑ ูุญุฏุฏ')}
        -  ุทุจูุนุฉ ุงูุนูู ูููููุฉ ูู ุฎูุงู ุงุณู ุงูููุงูุณุฉ: {d.get('Competition_Name', 'ุบูุฑ ูุญุฏุฏ')}
        ๐ง ุงููุทููุจ ูู ุงููุต:
        - ุงุฐูุฑ ุจูุถูุญ ูุง ูุฌุจ ุฃู ูุดููู ุงูุนุฑุถ ุงูููู ูู ูุซุงุฆู ููุญุชูู.
        - ุบููุฑ ุชุฑุชูุจ ูุชุฑููุฒ ุงูุนูุงุตุฑ **ููููุง ูุทุจูุนุฉ ุงููุดุฑูุน**:
            โข ุฅู ูุงู ุงููุดุฑูุน *ููุฏุณู*: ุฑููุฒ ุนูู ุงูุฑุณููุงุชุ ููุงุฆู ุงููููุงุชุ ุฎุทุฉ ุงูุชูููุฐุ ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉุ ุงูููุงุฑุฏ ูุงููุนุฏุงุช.
            โข ุฅู ูุงู *ุชููู*: ุฑููุฒ ุนูู ุงููููุฌูุฉุ ุงูุญููู ุงูุชูููุฉุ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏูุ ุงูุจููุฉ ุงูุชูููุฉุ ุฎุทุฉ ุงูุฃูู ุงูุณูุจุฑุงููุ ุฎุทุฉ ุงูุชุณููู.
            โข ุฅู ูุงู *ุฎุฏูู*: ุฑููุฒ ุนูู SLAุ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉุ ุฎุทุฉ ุงูุชูููุฐุ ูุฑุงูุจุฉ ุงูุฃุฏุงุก.
            โข ุฅู ูุงู *ุงุณุชุดุงุฑู*: ุฑููุฒ ุนูู ูููุฌูุฉ ุงูุนููุ ูุฑูู ุงูุฎุจุฑุงุกุ ุฎุทุฉ ุงูุฏุฑุงุณุงุชุ ุชุณููู ุงูุชูุงุฑูุฑ.

        โ๏ธ ุดุฑูุท ุงูุตูุงุบุฉ:
        - ุงุณุชุฎุฏู ูุบุฉ ุฑุณููุฉ ูุงุถุญุฉ.
        - ูุง ุชูุฑุฑ ุจูุงูุงุช ุงูุฌูุฉ ุฃู ุฃุณูุงุก ุงูุฃุดุฎุงุต ุฃู ุงูุฃุณุนุงุฑ ุงูููุฌูุฏุฉ ูู ุงููุฏุฎูุงุช.
        - ูุง ุชุณุชุฎุฏู ุฌูู ูุถูุงุถุฉุ ุงุฌุนู ุงููุญุชูู ูุงุจููุง ููุชูููู.
        - ูุฌุจ ุฃู ุชูุชูู ุงูููุฑุฉ ุจู:
        1) ุชุฃููุฏ ุฃู ุงููุณุชูุฏุงุช ุนูุตุฑ ุฃุณุงุณู ููุชูููู ุงูููู ูู ูุจู ุงููุฌูุฉ ุงููุฎุชุตุฉ.
        2) ุงูุชูุจูู ุจุฃู ุฌููุน ุงููุณุชูุฏุงุช ูุฌุจ ุฃู ุชููู ูููุนุฉ ููุฎุชููุฉ ุฑุณูููุง.

        โ๏ธ ุฃุฎุฑุฌ ุงููุต ุจุตูุงุบุฉ ุนุฑุจูุฉ ูุตุญูุ ููุณููุฉ ุจููุงุท ูุงุถุญุฉุ ุฏูู ูุจุงูุบุฉ.
        """,


        "Financial_Proposal_Documents": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ู "ูุซุงุฆู ุงูุนุฑุถ ุงููุงูู" ุชูุถูุญ ุงููุฑููุงุช ูุงููุณุชูุฏุงุช ุงูุชู ูุฌุจ ุฃู ููุฏูููุง ุงููุชูุงูุณ ุถูู ุนุฑุถู ุงููุงูู.
        ุงูุชุจ ุจุฃุณููุจ ุฑุณูู ููุจุงุดุฑุ ูุงุณุชุฎุฏู ุชุฑููููุง ูุงุถุญูุง (1ุ 2ุ 3...)ุ ุจุญูุซ ุชุชุถูู ุงูููุฑุฉ ูุง ููู:

        - ุฌุฏูู ุงููููุงุช ูุงูุฃุณุนุงุฑ ุงูุชูุตูููุฉ ููุงูุฉ ุงูุจููุฏ.
        - ุจูุงู ุฅุฌูุงูู ูููุฉ ุงูุนุฑุถ ุจุงูุฑูุงู ุงูุณุนูุฏู.
        - ุงูุถูุงู ุงูุงุจุชุฏุงุฆู ุจูุณุจุฉ ูุง ุชูู ุนู (1ูช) ูู ูููุฉ ุงูุนุฑุถ.
        - ุงูุดุฑูุท ุงููุงููุฉ ููุฏูุน ูุงูุฏูุนุงุช ุงููุฑุญููุฉ ุฅู ูุฌุฏุช.
        - ุงูุชุนูุฏ ุจุงูุงูุชุฒุงู ุจุดุฑูุท ุงูุชุนุงูุฏ ูุงูุถูุงู ุงูููุงุฆู.
        - ุฃู ุชูุถูุญุงุช ูุงููุฉ ุฅุถุงููุฉ ุชุฑุงูุง ุงูุฌูุฉ ุงูุญููููุฉ ุถุฑูุฑูุฉ.

        ุฃูุฏ ุนูู ุฃู ุงูุฃุณุนุงุฑ ุชุดูู ุฌููุน ุงูุชูุงููู ุงููุจุงุดุฑุฉ ูุบูุฑ ุงููุจุงุดุฑุฉุ ูุฃู ุงูุฌูุฉ ุงูุญููููุฉ ุบูุฑ ููุฒูุฉ ุจูุจูู ุฃูู ุงูุนุฑูุถ ุณุนุฑูุง.
        {context}
        """,
        # "Bid_Evaluation_Criteria": f"""
        # ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ูุนุงููุฑ ุชูููู ุงูุนุฑูุถ" ูุชุฏุฑุฌ ูู ูุฑุงุณุฉ ุงูุดุฑูุท ูุงูููุงุตูุงุช ุงูุฎุงุตุฉ ุจุงูููุงูุณุฉ.

        # ุงุณุชุฎุฏู ุงููุนูููุงุช ุงูุชุงููุฉ ููุตุฏุฑ ุณูุงูู ุนุงู ููุท ุฏูู ุชูุฑุงุฑูุง ูุตููุง ุฃู ุฐูุฑ ุชูุงุตูููุง ุงูุฅุฏุงุฑูุฉ:

        # {context}

        # ุงูุชุนูููุงุช:
        # - ุงุณุชุฎุฏู ุฃุณููุจูุง ุฑุณูููุง ููุงุถุญูุง ูุชูุงูููุง ูุน ููุงุฆุญ ููุฆุฉ ููุงุกุฉ ุงูุฅููุงู ูุงููุดุฑูุนุงุช ุงูุญููููุฉ (EXPRO).
        # - ุงุฌุนู ุงูููุฑุฉ ูุชูุงุฒูุฉ ุจูู ุงูุฌุงูุจูู ุงูููู ูุงููุงููุ ูุน ุฅุจุฑุงุฒ ูุจุงุฏุฆ ุงูุนุฏุงูุฉ ูุงูุดูุงููุฉ ูุชุญููู ุงููุตูุญุฉ ุงูุนุงูุฉ.
        # - ูุง ุชุซุจุช ุชูุฒูุน ุงููุณุจ (ูุซู 40% ููู ู60% ูุงูู) ุจู ุงุณุชุฎุฏู ุตูุงุบุฉ ูุฑูุฉ ุชุณูุญ ุจุชูููู ุงูุฃูุฒุงู ููู ููุน ุงููุดุฑูุน (ุงุณุชุดุงุฑูุ ููุฏุณูุ ุชูููุ ุชุดุบููู).
        # - ุงุณุชุฎุฏู ุชุฑููููุง ุฃุจุฌุฏููุง ุฃู ุชุฑุชูุจููุง (ุฃูููุงุ ุซุงูููุงุ ุซุงูุซูุง...) ุจุฏู ุงูููุงุท ุฃู ุงูุดุฑุทุงุช ูุนุฑุถ ุนูุงุตุฑ ุงูุชูููู ุงูููู ุจุดูู ููุณู ูู ุงููุต ุงูุนุฑุจู ุฏุงุฎู Word.
        # - ูุถูุญ ุงูุนูุงุตุฑ ุงูุฑุฆูุณูุฉ ุงูุชู ููููููู ุนูููุง ุงูุนุฑุถ ุงููููุ ูุชุดูู ุนูู ุณุจูู ุงููุซุงู:
        # ุฃูููุง: ุงููููุฌูุฉ ูุฎุทุฉ ุงูุชูููุฐ.  
        # ุซุงูููุง: ุงููุงุฏุฑ ุงูููู ูุงูุฎุจุฑุงุช.  
        # ุซุงูุซูุง: ุงูุฎุจุฑุฉ ุงูุณุงุจูุฉ ูุงููุดุงุฑูุน ุงูููุงุซูุฉ.  
        # ุฑุงุจุนูุง: ุฌูุฏุฉ ุงูุนุฑุถ ุงูููู ูุงููุณุชูุฏุงุช.  
        # ุฎุงูุณูุง: ุงูุฌุฏูู ุงูุฒููู ููุฏู ูุงูุนูุชู.
        # - ุฃูุถุญ ุฃู ุงูุชูููู ุงููุงูู ูุนุชูุฏ ุนูู ุงูุฃุณุนุงุฑ ุงูุฅุฌูุงููุฉ ูุงูุชูุตูููุฉ ููุฏู ุชูุงูููุง ูุน ุงูุณูู ูุฌูุฏุฉ ุงูุชุญููู ุงููุงูู.
        # - ุฃุถู ููุฑุฉ ูุตูุฑุฉ ุชุคูุฏ ุงูุงูุชุฒุงู ุจูุนุงููุฑ ุงููุญุชูู ุงููุญูู ูุงูููุดุขุช ุงูุตุบูุฑุฉ ูุงููุชูุณุทุฉุ ูุน ููุญ ุงูุฃูุถููุฉ ุงูุณุนุฑูุฉ ููููุชุฌ ุงููุทูู ุจูุณุจุฉ (10%) ุนูุฏ ุงูุทุจุงู ุงูุดุฑูุท.
        # - ุงุฎุชู ุงูููุฑุฉ ุจุฌููุฉ ุฑุณููุฉ ุชูุถุญ ุฃู ุงูุชุฑุณูุฉ ุชุชู ุนูู ุงูุนุฑุถ ุงูุญุงุตู ุนูู ุฃุนูู ุชูููู ููุงุฆู ุจุนุฏ ุชุญูู ุงููุชุทูุจุงุช ุงููููุฉ ูุงููุงููุฉ.

        # ุงูุชุจ ุงูููุฑุฉ ุจุงูุนุฑุจูุฉ ุงููุตุญูุ ุจูุบุฉ ูุซุงุฆู ุญููููุฉ ุฏูููุฉ ูููุณูุฉ ูุฌุงูุฒุฉ ููุฅุฏุฑุงุฌ ูู ูุฑุงุณุฉ ุงูุดุฑูุท.
        # """,



        "Service_Delivery_Plan": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุจุฑูุงูุฌ ุชูุฏูู ุงูุฎุฏูุงุช" ูุชุฏุฑุฌ ูู ูุฑุงุณุฉ ุงูุดุฑูุท ูุงูููุงุตูุงุช ุงูุฎุงุตุฉ ุจุงูููุงูุณุฉ.  
        ุงุณุชุฎุฏู ุงููุนูููุงุช ุงูุชุงููุฉ ููุตุฏุฑ ุณูุงูู ููุท ุฏูู ุฅุนุงุฏุฉ ุตูุงุบุชูุง ุญุฑูููุง ุฃู ุฐูุฑ ุชูุงุตูููุง ุงูุฅุฏุงุฑูุฉ:

        {context}

         ุงูุชุนูููุงุช:
        - ุตูุบ ุงููุต ุจุฃุณููุจ ุงุญุชุฑุงูู ูุงุถุญ ูููุงุณุจ ูููุดุฑูุนุงุช ุงูุญููููุฉ.  
        - ูุฌุจ ุฃู ุชุชููู ุงูููุฑุฉ ูุน ุทุจูุนุฉ ุงููุดุฑูุน (ุฎุฏููุ ุงุณุชุดุงุฑูุ ููุฏุณูุ ุชููู...).  
        - ูุถูุญ ุงูููุฑุฉ ุงูุนุงูุฉ ูุฎุทุฉ ุงูุชูููุฐ ููุฑุงุญู ุงูุนูู ุงูุฃุณุงุณูุฉุ ูุซู:
        โข ูุฑุญูุฉ ุงูุชุญุถูุฑ ูุงูุฅุนุฏุงุฏ.  
        โข ูุฑุญูุฉ ุงูุชูููุฐ ูุงููุชุงุจุนุฉ.  
        โข ูุฑุญูุฉ ุงูุชุณููู ูุงูุงุฎุชุจุงุฑุงุช ุงูููุงุฆูุฉ.  
        - ููููู ุฐูุฑ ุงูุฌุฏูู ุงูุฒููู ุจุดูู ูุตูู ุฏูู ุฃุฑูุงู ูุญุฏุฏุฉ.  
        - ุฃุดุฑ ุฅูู ุชูุธูู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ ูุงููููุฉ ูุฎุทุฉ ุชูุฒูุนูุง ุญุณุจ ูุฑุงุญู ุงูุชูููุฐ.  
        - ูุถูุญ ุฃูููุฉ ุงูุงูุชุฒุงู ุจุงูุฌูุฏุฉ ุงูุฒูููุฉ ูุงููููุฉุ ูุงูุชูุงุฑูุฑ ุงูุฏูุฑูุฉ ุงูููุฏูุฉ ููุฌูุฉ ุงูุญููููุฉ.  
        - ุงุณุชุฎุฏู ูุบูุฉ ุฑุณููุฉ ูุชูุงุณูุฉ ูุน ุฃุณููุจ ููุฆุฉ ููุงุกุฉ ุงูุฅููุงู ูุงููุดุฑูุนุงุช ุงูุญููููุฉ (EXPRO).  

        ุงูุชุจ ุงูููุฑุฉ ุจูุบุฉ ุนุฑุจูุฉ ูุตุญูุ ุฎุงููุฉ ูู ุงูุชูุงุตูู ุงูุฅุฏุงุฑูุฉ ูุซู ุงูุฃุณูุงุก ุฃู ุงูุชูุงุฑูุฎ ุฃู ุงูููู ุงููุงููุฉ.
        """,

        "Tender_Split_Section": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุชุฌุฒุฆุฉ ุงูููุงูุณุฉ" ุชูุถูุญ ุฃู ุงูุฌูุฉ ูุฏ ุชููู ุจุชุฌุฒุฆุฉ ุจููุฏ ุงูููุงูุณุฉ
        ูุชุฑุณูุฉ ุฃุฌุฒุงุก ูููุง ุนูู ุฃูุซุฑ ูู ูุชุนูุฏ ุนูุฏ ูุฌูุฏ ูุจุฑุฑุงุช ูููุฉ ุฃู ุชุดุบูููุฉุ
        ูุน ุงูุชุฃููุฏ ุนูู ูุถูุญ ูุทุงู ูู ุฌุฒุกุ ููุนุงููุฑ ุงูุชูููู ุงููุณุชููุฉุ
        ูุนุฏู ุงุณุชุฎุฏุงู ุงูุชุฌุฒุฆุฉ ููุงูุชูุงู ุนูู ุงูุฃูุธูุฉ ุฃู ุชุฌุฒุฆุฉ ุงููููุฉ ุจุดูู ุบูุฑ ูุดุฑูุน.
        {context}
        """,

        "Text_of_Costs_of_Competition_Documents": f"""
        ุญููู ุงูุฑูู ุงูุชุงูู ุฅูู ูุต ุนุฑุจู ููุชูุจ ุจุงูุญุฑูู ููุทุ ุจุฏูู ุฃู ุฌููุฉ ุฅุถุงููุฉุ ุจุฏูู ุชูุณููุ ูุจุฏูู ุฐูุฑ ูููุฉ (ุฑูุงู):
        ุงูุฑูู: {d.get("Competition_Document_Fees", "ุบูุฑ ูุญุฏุฏ")}

        ุงูุชุนูููุงุช ุงููููุฉ:
        - ุงููุงุชุฌ ูุฌุจ ุฃู ูููู ูุตูุง ุนุฑุจููุง ููุท.
        - ูุง ุชูุชุจ ุงูุฑูู ูุฑุฉ ุฃุฎุฑู.
        - ูุง ุชุถู ุฃู ูููุงุช ูุซู (ูููุฉ โ ูุจูุบ โ ุฑูุงู โ ููุท ูุง ุบูุฑ).
        - ุงููุงุชุฌ ูุฌุจ ุฃู ูุญุชูู ุนูู ุงููุต ููุทุ ูุซุงู: "ุฎูุณูุฆุฉ".
        """,

        "Inquiries_Section": f"""
        ุตุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุงูุงุณุชูุณุงุฑุงุช ูุงููุฑุงุณูุงุช".
        ุงูุชุนูููุงุช:
        - ูุถุญ ุฃู ุงูุงุณุชูุณุงุฑุงุช ุชูุฏู ุฎูุงู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ ููุท.
        - ูุฌุจ ุฃู ุชุฑุณู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุฎุตุต ููุงุณุชูุณุงุฑุงุช.
        - ุงูุฑุฏูุฏ ุชุตุฏุฑ ูู ุงูุฌูุฉ ุงูุญููููุฉ ูุชุนุชุจุฑ ุฌุฒุกูุง ูู ูุซุงุฆู ุงูููุงูุณุฉ.

        ุงุณุชุฎุฏู ุงูุฃุณููุจ ุงูุฑุณูู ุงูุชุงูู:

        ูุญู ูููุชูุงูุณูู ุฑูุน ุงูุงุณุชูุณุงุฑุงุช ุงููุชุนููุฉ ุจุงูููุงูุณุฉ ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุนุชูุฏ
        ุฎูุงู ูุชุฑุฉ ุงูุงุณุชูุณุงุฑุงุช ุงููุญุฏุฏุฉ ูู ุงูุฌุฏูู ุงูุฒูููุ ููุนุชุจุฑ ุฃู ุฑุฏ ููุชูุจ ูุตุฏุฑ ุนู ุงูุฌูุฉ
        ุงูุญููููุฉ ุฌุฒุกูุง ูุง ูุชุฌุฒุฃ ูู ูุซุงุฆู ุงูููุงูุณุฉุ ูููุชุฒู ุงููุชูุงูุณูู ุจูุถูููู.
        """,

        "Penalties": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุงูุบุฑุงูุงุช ูุงูุฌุฒุงุกุงุช" ุจูุงุกู ุนูู ุงูุฎูุงุฑุงุช ุงูุชุงููุฉ:

        - ุงูุญุณู ูู ุงููุณุชุญูุงุช ุงููุงููุฉ: {d.get("Penalty_Deduction", False)}
        - ุชูููุฐ ุงูุฃุนูุงู ุนูู ุญุณุงุจ ุงููุชุนุงูุฏ: {d.get("Penalty_Execute_On_Vendor", False)}
        - ุฅููุงู ุงูุนูู ูุคูุชุงู: {d.get("Penalty_Suspend", False)}
        - ูุณุฎ ุงูุนูุฏ ูุณุญุจ ุงููุดุฑูุน: {d.get("Penalty_Termination", False)}

        ุงูุชุนูููุงุช:
        - ูุง ุชุณุชุฎุฏู ููุงุท ุฃู ุชุฑููู.
        - ุงุฌุนู ุงููุต ููุฑุฉ ูุงุญุฏุฉ ุฑุณููุฉ ูุงููููุฉ ุจุตูุงุบุฉ ุญููููุฉ.
        - ุงุฑุจุทู ุจุงููุตูุญุฉ ุงูุนุงูุฉ ูุฌูุฏุฉ ุงูุชูููุฐ.
        """,


        "Delay_Penalties": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุบุฑุงูุงุช ุงูุชุฃุฎูุฑ" ุชุนุชูุฏ ุนูู ุงููุณุจุฉ ุงูุชุงููุฉ:
        ูุณุจุฉ ุงูุบุฑุงูุฉ ุงููุตูู: {d.get("Max_Penalty_Percentage", "ุบูุฑ ูุญุฏุฏุฉ")}% ูู ุงููููุฉ ุงูุฅุฌูุงููุฉ ููุนูุฏ.

        ุงูุชุนูููุงุช:
        - ูุฌุจ ุฃู ุชููู ุงูููุฑุฉ ูุงุถุญุฉ ูุชุทุจูููุฉ ูููุณุช ุชุนุฑูููุฉ.
        - ุงุดุฑุญ ุฃู ุงูุบุฑุงูุฉ ุชุทุจู ุนูุฏ ุชุฌุงูุฒ ุงูุฌุฏูู ุงูุฒููู ุฃู ุงููุฑุงุญู.
        - ูุถูุญ ุฃู ุงูุบุฑุงูุฉ ุชูุญุชุณุจ ูููููุง ุฃู ูุฑุญูููุง ุญุณุจ ููุน ุงููุดุฑูุน.
        - ุฃุถู ุฃู ุงุณุชููุงู ุงูุชูููุฐ ูุง ููุบู ุงูุบุฑุงูุฉ ุงููุชุฑุชุจุฉ.
        - ูุง ุชุณุชุฎุฏู ููุงุท ุฃู ุชุฑูููุ ุจู ููุฑุฉ ูุงุญุฏุฉ ุฑุณููุฉ.

        ุงูุชุจ ุงููุต ุจุงูุนุฑุจูุฉ ุงููุตุญู ูุจุตูุงุบุฉ ุญููููุฉ ููุงุณุจุฉ ูููุฑุงุณุงุช.
        """,

        "Insurance": f"""
        ุตูุบ ููุฑุฉ ุฑุณููุฉ ุจุนููุงู "ุงูุชุฃูููุงุช".

        ูุฌุจ ุนูู ุงููุชุนุงูุฏ ุชูุฏูู ูุซุงุฆู ุงูุชุฃููู ุงููุนุชูุฏุฉ ูุจู ุจุฏุก ุงูุชูููุฐุ ุจูุง ูุดูู โ ุนูู ุญุณุจ ุทุจูุนุฉ ุงููุดุฑูุน โ ุงูุชุฃููู ุนูู ุงูุนุงููููุ ุงููุนุฏุงุชุ ูุงููููุน ุฃู ุงูููุชููุงุช ุงููุฑุชุจุทุฉ ุจุฃุนูุงู ุงูููุงูุณุฉ. ุชููู ูุซุงุฆู ุงูุชุฃููู ุณุงุฑูุฉ ุทูุงู ูุฏุฉ ุงูุนูุฏุ ููุนุฏ ุนุฏู ุชูุฏูููุง ุฃู ุชุฌุฏูุฏูุง ุฅุฎูุงูุงู ุชุนุงูุฏููุง ูุชุฑุชุจ ุนููู ุงุชุฎุงุฐ ุงูุฅุฌุฑุงุกุงุช ุงููุธุงููุฉุ ุจูุง ูู ุฐูู ุฅููุงู ุงูุฃุนูุงู ุฃู ุชุทุจูู ุงูุฌุฒุงุกุงุช ุญุณุจ ุงูุนูุฏ.
        """,

        # "Materials_Specification_Table": f"""
        # ุตุบ ููุฑุฉ ุชูููุฏูุฉ ูุฌุฏูู "ููุงุตูุงุช ุงูููุงุฏ".
        # ุงูุชุนูููุงุช:
        # - ูุถูุญ ุฃู ุฌููุน ุงูููุงุฏ ูุฌุจ ุฃู ุชููู ูุทุงุจูุฉ ููููุงุตูุงุช ุงููุนุชูุฏุฉ.
        # - ูุชู ุชูุฏูู ููุงุตูุงุช ุชูุตูููุฉ ูู ุงูููุฑุฏ ุฃุซูุงุก ุงูุชูููุฐ.

        # ูุซุงู ุตูุงุบุฉ:

        # ูุฌุจ ุฃู ุชููู ุงูููุงุฏ ุงููุณุชุฎุฏูุฉ ูุทุงุจูุฉ ููููุงุตูุงุช ุงููููุฉ ุงููุนุชูุฏุฉ
        # ููุนุงููุฑ ุงูุฌูุฏุฉ ุงููุนุชุฑู ุจูุงุ ูููุฏู ุงููุชูุงูุณ ุถูู ุนุฑุถู ุงูููุงุตูุงุช ุงูุชูุตูููุฉ
        # ููููุงุฏ ุงูููุชุฑุญุฉ ููู ุงููููุฐุฌ ุงููุนุชูุฏ ูู ุงูุฌูุฉ ุงูุญููููุฉ.
        # """,

        # "Equipment_Specification_Table": f"""
        # ุตุบ ููุฑุฉ ุชูููุฏูุฉ ูุฌุฏูู "ููุงุตูุงุช ุงูุฃุฌูุฒุฉ ูุงููุนุฏุงุช".
        # ุงูุชุนูููุงุช:
        # - ูุถุญ ุฃู ุงููุนุฏุงุช ูุฌุจ ุฃู ุชููู ุญุฏูุซุฉ ูููุงุฆูุฉ ูุทุจูุนุฉ ุงููุดุฑูุน.

        # ูุซุงู ุตูุงุบุฉ:

        # ููุชุฒู ุงููุชูุงูุณ ุจุชูููุฑ ุงูุฃุฌูุฒุฉ ูุงููุนุฏุงุช ุงููุงุฒูุฉ ูุชูููุฐ ุงูุฃุนูุงู ููู ุฃุนูู ูุนุงููุฑ ุงูุฌูุฏุฉุ
        # ูุจูุง ูุชูุงุณุจ ูุน ุทุจูุนุฉ ุงููุดุฑูุนุ ูููุฏู ุถูู ุนุฑุถู ุงูููู ุงูููุงุตูุงุช ุงููููุฉ ูุชูู ุงููุนุฏุงุช.
        # """,

        "Service_Execution_Method": f"""
        ุตุบ ููุฑุฉ ุจุนููุงู "ูููุฌูุฉ ุชูููุฐ ุงูุฎุฏูุงุช".
        ุงูุชุนูููุงุช:
        - ูุถุญ ุขููุฉ ุงูุชูููุฐุ ุชูุฒูุน ุงูููุงูุ ูุฑุงุญู ุงูุนููุ ุงูุชูุงุฑูุฑ.
        - ูุง ุชุฐูุฑ ุฃุณูุงุก ุฃู ุชูุงุฑูุฎ.
        - ุฃุณููุจ ุฑุณูู.

        ูุซุงู ุตูุงุบุฉ:

        ููุชุฒู ุงููุชุนุงูุฏ ุจุชุทุจูู ูููุฌูุฉ ุชูููุฐ ูุงุถุญุฉ ุชุดูู ูุฑุงุญู ุจุฏุก ุงูุนููุ
        ุงูุชุฎุทูุทุ ุงูุชูููุฐุ ุงููุชุงุจุนุฉ ุงูุฏูุฑูุฉุ ูุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑุ ุจูุง ูุถูู ุชุญููู ุฃูุฏุงู ุงููุดุฑูุน
        ูุงููุญุงูุธุฉ ุนูู ุงูุฌูุฏุฉ ูุงูุงูุชุฒุงู ุจุงููุฎุฑุฌุงุช ุงููุชูู ุนูููุง.
        """

    }

    independent = [s for s in sections if s != "Bid_Evaluation_Criteria"]
    dependent = "Bid_Evaluation_Criteria" in sections

    async def _parallel_generate():
        # โ PARALLEL GENERATION
        tasks = []
        keys = []

        for sec in independent:
            if sec in prompts:
                tasks.append(_call_llm_async(llm, prompts[sec]))
                keys.append(sec)

        results = await asyncio.gather(*tasks, return_exceptions=True)

        for sec, result in zip(keys, results):
            d[sec] = result if isinstance(result, str) else "ุฎุทุฃ ุฃุซูุงุก ุงูุชูููุฏ."

        # โ AFTER TECH & FIN ARE READY โ Generate evaluation criteria
        if dependent:
            tech = d.get("Technical_Proposal_Documents", "")
            fin = d.get("Financial_Proposal_Documents", "")

            eval_prompt = f"""
            ุจูุงุกู ุนูู ุงููุญุชูู ุงูุชุงูู ูู ุงูุนุฑุถ ุงูููู ูุงููุงููุ ูู ุจุชุญูููู ุฅูู ูููุฐุฌ ูุนุงููุฑ ุชูููู ุนุฑูุถ ุฌุงูุฒ ููุฅุฏุฑุงุฌ ูู ูุฑุงุณุฉ ุงูุดุฑูุทุ ูุน ุฌุฏูู ุชูููู ูุงุถุญ:

            ุงูุนุฑุถ ุงูููู:
            {tech}

            ุงูุนุฑุถ ุงููุงูู:
            {fin}

            โ๏ธ ุงูุชุนูููุงุช:

            1) ุฃูุดุฆ ุฌุฏููุงู ูู ูุณุชูููู:
            - ุงููุณุชูู ุงูุฃูู: ููู / ูุงูู
            - ุงููุณุชูู ุงูุซุงูู: ุนูุงุตุฑ ุงูุชูููู ุฏุงุฎู ูู ูุณุชูู

            2) ุงุณุชุฎุฏู ุชูุฒูุน ุงูููุงุท ุจูุงุกู ุนูู ุงูููุงุฑุณุงุช ุงูุญููููุฉ ุงูุดุงุฆุนุฉ:
            - ุฅุฐุง ูุงู ูุดุฑูุน ุฎุฏูุงุช / ุชูููุฉ โ ุงูุชูุฒูุน ุงูููุชุฑุญ (70% ููู / 30% ูุงูู)
            - ุฅุฐุง ูุงู ูุดุฑูุน ุฅูุดุงุกุงุช ุฃู ุชูููุฐ ููุฏุงูู โ ุงูุชูุฒูุน ุงูููุชุฑุญ (60% ููู / 40% ูุงูู)

            3) ุฏุงุฎู ุงูุชูููู ุงููููุ ูุง ุชุชุฌุงูุฒ 5 ุนูุงุตุฑ ุฑุฆูุณูุฉ ููุท ูุฃุฎูุฐุฉ ูู ุงูุนุฑุถ ุงูููู:
            ูุซุงู ููุนูุงุตุฑ ุงููุญุชููุฉ:
            - ูููุฌูุฉ ุงูุนูู ูุฎุทุฉ ุงูุชูููุฐ
            - ุงูุฎุจุฑุงุช ุงูุณุงุจูุฉ ููุฑูู ุงูุนูู
            - ุฌูุฏุฉ ุงูุญู ูุงูููุงุตูุงุช ุงููููุฉ
            - ุฎุทุฉ ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูุงููุฎุงุทุฑ
            - ุงูุงูุชุฒุงู ุจุงูุชุณููู ูุงููุฑุงุญู ุงูุฒูููุฉ

            4) ุฏุงุฎู ุงูุชูููู ุงููุงููุ ูุง ุชุชุฌุงูุฒ ุนูุตุฑูู:
            - ุงูุณุนุฑ
            - ูุถูุญ ุฌุฏูู ุงููููุงุช ูุงูุชูุตููุงุช ูุงูุฃุณุนุงุฑ

            5) ูุง ุชุณุชุฎุฏู ุฃุฑูุงู ูุซูุฑุฉุ ุงุณุชุฎุฏู ูููุฐุฌ ุงูุชูุฒูุน ูู ุงูุฃูุซูุฉ ุงูุชุงููุฉ:

            ุงููุณุชูู ุงูุฃูู | ุงููุณุชูู ุงูุซุงูู | ุงููุฒู | ุงูููุงุท

            6) ุงุฎุชุชู ุจุนุจุงุฑุฉ ุฑุณููุฉ:
            "ูุชู ุชุฑุณูุฉ ุงูููุงูุณุฉ ุนูู ุงูุนุฑุถ ุงูุญุงุตู ุนูู ุฃุนูู ูุฌููุน ููุงุท ุจุนุฏ ุงูุชูููู ุงูููู ูุงููุงูู."

            โ ููููุน:
            - ูุชุงุจุฉ ุดุฑุญ ุทููู ุฃู ููุฑุงุช ุณุฑุฏูุฉ.
            โ ูุทููุจ:
            - ุฌุฏูู ุชูููู ููุณู ููุท.

            ุงูุชุจ ุจุตูุงุบุฉ ูุฑุงุณุฉ ุดุฑูุท ุฑุณููุฉ.
            """



            d["Bid_Evaluation_Criteria"] = await _call_llm_async(llm, eval_prompt)

    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.run_until_complete(_parallel_generate())
    loop.close()

    return {"decisions": d}



def synthesizer(state):
    return {"decisions": state.get("decisions", {})}

def build_orchestrator_graph(llm):
    g = StateGraph(State)
    g.add_node("orchestrator", orchestrator)
    g.add_node("generate_all_sections", lambda s: generate_all_sections(s, llm))
    g.add_node("synthesizer", synthesizer)
    g.add_edge(START, "orchestrator")
    g.add_edge("orchestrator", "generate_all_sections")
    g.add_edge("generate_all_sections", "synthesizer")
    g.add_edge("synthesizer", END)
    return g.compile()
